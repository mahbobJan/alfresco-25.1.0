map $http_origin $cors_origin {
    default "";
    "http://localhost:8081" "http://localhost:8081";
    "https://yourdomain.com" "https://yourdomain.com";
	"http://192.168.1.3:3000" "http://192.168.1.3:3000";
}

server {
  listen 8084;

  server_name localhost;

  location / {
    proxy_pass http://content-app:8080;
	
	# CORS headers
    add_header Access-Control-Allow-Origin $cors_origin always;
	add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token' always;

    if ($request_method = OPTIONS ) {
        add_header Access-Control-Allow-Origin $cors_origin;
		add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token';
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
  }

# برای درخواست دقیق /share/ (با اسلش پایانی)
location = /share/ {
    proxy_pass http://share:8080/share/;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token' always;
}

# برای بقیه مسیرهای share
location /share/ {
    rewrite ^/share(/.*)$ $1 break;
    proxy_pass http://share:8080;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token' always;

    if ($request_method = OPTIONS ) {
        add_header Access-Control-Allow-Origin $cors_origin;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token';
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}
  

  location /alfresco/ {
    proxy_pass http://alfresco:8080/alfresco/;
	
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;

    proxy_pass_request_headers on;
    proxy_pass_request_body on;
    proxy_redirect off;

	
	# CORS headers
    add_header Access-Control-Allow-Origin $cors_origin always;
	add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token' always;

    if ($request_method = OPTIONS ) {
        add_header Access-Control-Allow-Origin $cors_origin;
		add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token';
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
  }

  location /api/ {
    proxy_pass http://alfresco:8080/api/;
	
	# CORS headers
    add_header Access-Control-Allow-Origin $cors_origin always;
	add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token' always;

    if ($request_method = OPTIONS ) {
        add_header Access-Control-Allow-Origin $cors_origin;
		add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token';
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
  }

  location /assets/ {
    proxy_pass http://content-app:8080/assets/;
	
	# CORS headers
    add_header Access-Control-Allow-Origin $cors_origin always;
	add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token' always;

    if ($request_method = OPTIONS ) {
        add_header Access-Control-Allow-Origin $cors_origin;
		add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization, X-Csrf-Token';
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
  }

	location /thumb-proxy/ {
		internal;
		proxy_pass_request_body on;
		proxy_pass_request_headers on;

		set $ticket "";
		if ($arg_alf_ticket != "") {
			set $ticket $arg_alf_ticket;
		}

		# اضافه کردن header یا کوکی auth
		proxy_set_header Cookie "Alfresco-Ticket=$ticket";

		proxy_pass http://alfresco:8080/alfresco/api/-default-/public/alfresco/versions/1/nodes/$arg_nodeId/renditions/doclib/content;
	}

  
}  
